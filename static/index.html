<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SENSEI â€” Biological Age Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600;700;800;900&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', sans-serif;
            background: #000;
            color: #fff;
            min-height: 100vh;
        }
        .font-orbitron { font-family: 'Orbitron', monospace; }
        
        .bio-circle {
            position: relative;
            width: 240px;
            height: 240px;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, #1a3d2e 0%, #0d1f17 50%, #000 100%);
            box-shadow: 0 0 60px rgba(0, 255, 128, 0.2), inset 0 0 60px rgba(0, 255, 128, 0.1);
        }
        
        .bio-circle::before {
            content: '';
            position: absolute;
            inset: 6px;
            border-radius: 50%;
            border: 2px solid rgba(0, 255, 128, 0.3);
        }
        
        .particle {
            position: absolute;
            width: 3px;
            height: 3px;
            background: #00ff88;
            border-radius: 50%;
            opacity: 0.6;
            animation: float 3s ease-in-out infinite;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0) scale(1); opacity: 0.6; }
            50% { transform: translateY(-15px) scale(1.2); opacity: 1; }
        }
        
        .impact-bar {
            height: 6px;
            border-radius: 3px;
            background: #1a1a2e;
            overflow: hidden;
        }
        
        .impact-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 1s ease;
        }
        
        .card {
            background: linear-gradient(145deg, #111 0%, #0a0a0a 100%);
            border: 1px solid #222;
            border-radius: 16px;
        }
        
        .input-dark {
            background: #111;
            border: 1px solid #333;
            color: #fff;
            transition: all 0.3s;
        }
        .input-dark:focus {
            border-color: #00ff88;
            outline: none;
            box-shadow: 0 0 20px rgba(0, 255, 128, 0.2);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #00ff88 0%, #00cc6a 100%);
            color: #000;
            font-weight: 600;
            transition: all 0.3s;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(0, 255, 128, 0.3);
        }
        
        .btn-outline {
            background: transparent;
            border: 1px solid #00ff88;
            color: #00ff88;
        }
        .btn-outline:hover {
            background: #00ff88;
            color: #000;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fadeIn { animation: fadeIn 0.6s ease forwards; }
        
        .chat-bubble-ai {
            background: linear-gradient(135deg, #1a3d2e 0%, #0d1f17 100%);
            border: 1px solid #00ff8840;
            border-radius: 16px 16px 16px 4px;
        }
        
        .chat-bubble-user {
            background: #222;
            border-radius: 16px 16px 4px 16px;
        }
        
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #000; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        const API = window.location.origin;
        
        // ==================== COMPONENTS ====================
        
        const Particles = () => {
            const particles = Array.from({ length: 20 }, (_, i) => ({
                id: i,
                left: Math.random() * 100,
                top: Math.random() * 100,
                delay: Math.random() * 3,
                size: 2 + Math.random() * 3
            }));
            return (
                <>
                    {particles.map(p => (
                        <div key={p.id} className="particle" style={{
                            left: `${p.left}%`, top: `${p.top}%`,
                            width: p.size, height: p.size,
                            animationDelay: `${p.delay}s`
                        }} />
                    ))}
                </>
            );
        };
        
        const BioAgeCircle = ({ bioAge, realAge, paceOfAging }) => {
            const diff = (realAge && bioAge) ? (realAge - bioAge) : 0;
            const isYounger = diff > 0;
            
            return (
                <div className="flex flex-col items-center">
                    <div className="bio-circle flex items-center justify-center">
                        <Particles />
                        <div className="text-center z-10">
                            <div className="font-orbitron text-5xl font-bold text-white">
                                {bioAge?.toFixed(1) || '--'}
                            </div>
                            <div className="text-xs text-gray-400 uppercase tracking-widest mt-1">
                                Biological Age
                            </div>
                            {realAge && bioAge && (
                                <div className={`mt-2 text-sm font-bold ${isYounger ? 'text-[#00ff88]' : 'text-[#ff4444]'}`}>
                                    {isYounger ? `${diff.toFixed(1)} years younger` : `${Math.abs(diff).toFixed(1)} years older`}
                                </div>
                            )}
                        </div>
                    </div>
                    
                    {paceOfAging !== null && paceOfAging !== undefined && (
                        <div className="mt-4 text-center">
                            <div className="text-xs text-gray-500 uppercase tracking-widest">Pace of Aging</div>
                            <div className={`font-orbitron text-xl font-bold ${paceOfAging <= 0 ? 'text-[#00ff88]' : 'text-[#ff4444]'}`}>
                                {paceOfAging <= 0 ? paceOfAging.toFixed(1) : '+' + paceOfAging.toFixed(1)}x
                            </div>
                        </div>
                    )}
                </div>
            );
        };
        
        const ImpactBar = ({ label, value, icon, description }) => {
            const isPositive = value <= 0;
            const absValue = Math.abs(value || 0);
            const percentage = Math.min((absValue / 2.5) * 100, 100);
            
            return (
                <div className="card p-4">
                    <div className="flex justify-between items-center mb-2">
                        <div className="flex items-center gap-2">
                            <span className="text-lg">{icon}</span>
                            <span className="text-sm text-gray-400">{label}</span>
                        </div>
                        <div className={`font-orbitron font-bold ${isPositive ? 'text-[#00ff88]' : 'text-[#ff6b35]'}`}>
                            {value !== null && value !== undefined ? (isPositive ? value.toFixed(1) : '+' + Math.abs(value).toFixed(1)) : '--'} yr
                        </div>
                    </div>
                    <div className="impact-bar">
                        <div className="impact-fill" style={{
                            width: `${percentage}%`,
                            background: isPositive ? 'linear-gradient(90deg, #00ff88, #00cc6a)' : 'linear-gradient(90deg, #ff6b35, #ff4444)'
                        }} />
                    </div>
                    {description && <div className="text-xs text-gray-500 mt-1">{description}</div>}
                </div>
            );
        };
        
        const TrendChart = ({ data, realAge }) => {
            const canvasRef = useRef(null);
            const chartRef = useRef(null);
            
            useEffect(() => {
                if (!canvasRef.current || !data?.length) return;
                if (chartRef.current) chartRef.current.destroy();
                
                const ctx = canvasRef.current.getContext('2d');
                chartRef.current = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: data.map(d => new Date(d.date).toLocaleDateString('it-IT', { day: '2-digit', month: 'short' })),
                        datasets: [
                            {
                                label: 'Bio Age',
                                data: data.map(d => d.biological_age),
                                borderColor: '#00ff88',
                                backgroundColor: 'rgba(0, 255, 136, 0.1)',
                                fill: true,
                                tension: 0.4,
                                pointRadius: 1
                            },
                            {
                                label: 'Real Age',
                                data: data.map(() => realAge),
                                borderColor: '#444',
                                borderDash: [5, 5],
                                pointRadius: 0
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { labels: { color: '#666', font: { size: 10 } } } },
                        scales: {
                            x: { grid: { color: '#1a1a1a' }, ticks: { color: '#444', font: { size: 9 } } },
                            y: { grid: { color: '#1a1a1a' }, ticks: { color: '#444' }, suggestedMin: realAge - 8, suggestedMax: realAge + 4 }
                        }
                    }
                });
                return () => { if (chartRef.current) chartRef.current.destroy(); };
            }, [data, realAge]);
            
            return (
                <div className="card p-4">
                    <h3 className="text-xs text-gray-400 uppercase tracking-widest mb-3">ðŸ“ˆ Trend (90 days)</h3>
                    <div style={{ height: 200 }}><canvas ref={canvasRef}></canvas></div>
                </div>
            );
        };
        
        const MetricBox = ({ icon, label, value, unit, color = '#00ff88' }) => (
            <div className="card p-3 text-center">
                <div className="text-xl mb-1">{icon}</div>
                <div className="font-orbitron text-xl font-bold" style={{ color }}>
                    {value ?? '--'}{unit && <span className="text-xs text-gray-500 ml-1">{unit}</span>}
                </div>
                <div className="text-xs text-gray-500 uppercase mt-1">{label}</div>
            </div>
        );
        
        const Loading = () => (
            <div className="min-h-screen flex flex-col items-center justify-center">
                <div className="w-12 h-12 border-4 border-[#111] border-t-[#00ff88] rounded-full animate-spin mb-4"></div>
                <div className="text-gray-500">Loading...</div>
            </div>
        );
        
        // ==================== AI COACH ====================
        
        const AICoach = ({ userData }) => {
            const [messages, setMessages] = useState([]);
            const [input, setInput] = useState('');
            const [loading, setLoading] = useState(false);
            const chatRef = useRef(null);
            
            useEffect(() => {
                // Initial greeting based on data
                if (userData && messages.length === 0) {
                    const greeting = generateGreeting(userData);
                    setMessages([{ role: 'ai', text: greeting }]);
                }
            }, [userData]);
            
            useEffect(() => {
                if (chatRef.current) {
                    chatRef.current.scrollTop = chatRef.current.scrollHeight;
                }
            }, [messages]);
            
            const generateGreeting = (data) => {
                const bioAge = data.averages?.biological_age;
                const realAge = data.real_age;
                const recovery = data.averages?.recovery;
                const sleep = data.averages?.sleep_hours;
                
                let greeting = `ðŸ¥‹ **Benvenuto, guerriero.**\n\n`;
                
                if (bioAge && realAge) {
                    const diff = realAge - bioAge;
                    if (diff > 2) {
                        greeting += `Il tuo corpo ha **${bioAge.toFixed(1)} anni** - sei **${diff.toFixed(1)} anni piÃ¹ giovane** della tua etÃ  anagrafica! Eccellente lavoro.\n\n`;
                    } else if (diff < -2) {
                        greeting += `Il tuo corpo mostra **${bioAge.toFixed(1)} anni** - c'Ã¨ margine di miglioramento. Ma ogni viaggio inizia con un passo.\n\n`;
                    } else {
                        greeting += `Il tuo corpo ha **${bioAge.toFixed(1)} anni** - in linea con la tua etÃ . Possiamo fare di meglio insieme.\n\n`;
                    }
                }
                
                greeting += `Sono qui per guidarti. Chiedimi:\n`;
                greeting += `â€¢ Come posso dormire meglio?\n`;
                greeting += `â€¢ Cosa devo fare oggi?\n`;
                greeting += `â€¢ Come abbasso la mia etÃ  biologica?\n`;
                greeting += `â€¢ Analizza i miei dati\n\n`;
                greeting += `*"Il maestro appare quando l'allievo Ã¨ pronto."*`;
                
                return greeting;
            };
            
            const generateResponse = (question, data) => {
                const q = question.toLowerCase();
                const avgs = data.averages || {};
                const impacts = avgs.bio_impacts || {};
                const today = data.today || {};
                
                // Sleep advice
                if (q.includes('sonno') || q.includes('dormi') || q.includes('sleep')) {
                    const sleepHours = avgs.sleep_hours;
                    let response = `ðŸŒ™ **Analisi del Sonno**\n\n`;
                    if (sleepHours) {
                        response += `Stai dormendo in media **${sleepHours.toFixed(1)} ore**.\n\n`;
                        if (sleepHours < 6) {
                            response += `âš ï¸ **Allarme critico!** Sotto le 6 ore stai danneggiando:\n- Sistema immunitario\n- Recupero muscolare\n- Funzioni cognitive\n- Equilibrio ormonale\n\n`;
                            response += `**Azione immediata:**\n1. Stasera vai a letto 1 ora prima\n2. Niente schermi 1h prima di dormire\n3. Camera fresca (18-19Â°C)\n4. OscuritÃ  totale\n\n`;
                        } else if (sleepHours < 7) {
                            response += `Quasi ci sei, ma il target Ã¨ **7-8 ore**.\n\n`;
                            response += `**Consiglio:** Aggiungi 30 minuti. Il sonno Ã¨ il miglior anabolizzante naturale.\n\n`;
                        } else {
                            response += `âœ“ **Ottimo range!** Mantieni questa abitudine.\n\n`;
                        }
                    }
                    response += `*"Il sonno Ã¨ il cugino della morte, ma anche il padre della rigenerazione."*`;
                    return response;
                }
                
                // Today advice
                if (q.includes('oggi') || q.includes('today') || q.includes('fare')) {
                    const recovery = today.scores?.recovery || avgs.recovery;
                    let response = `âš¡ **Piano per Oggi**\n\n`;
                    
                    if (recovery >= 80) {
                        response += `ðŸ”¥ Recovery al **${recovery}%** - SEI UNA MACCHINA!\n\n`;
                        response += `**Oggi puoi:**\n- Allenamento ad alta intensitÃ \n- HIIT o pesi pesanti\n- Spingi i tuoi limiti\n\n`;
                        response += `Il tuo corpo Ã¨ pronto. Non sprecarlo.`;
                    } else if (recovery >= 50) {
                        response += `ðŸ’ª Recovery al **${recovery}%** - Buono ma non strafare.\n\n`;
                        response += `**Oggi consiglio:**\n- Allenamento moderato\n- Lavoro tecnico\n- Cardio zona 2-3\n\n`;
                        response += `Ascolta il corpo. La costanza batte l'intensitÃ .`;
                    } else {
                        response += `ðŸ˜´ Recovery al **${recovery || '--'}%** - Il corpo chiede riposo.\n\n`;
                        response += `**Oggi focus su:**\n- Riposo attivo (camminata, stretching)\n- Meditazione\n- Sonno extra\n- Nutrizione di qualitÃ \n\n`;
                        response += `*"Anche il guerriero piÃ¹ forte deve affilare la spada in silenzio."*`;
                    }
                    return response;
                }
                
                // Biological age
                if (q.includes('etÃ ') || q.includes('biologica') || q.includes('age') || q.includes('giovane')) {
                    let response = `ðŸ§¬ **Come abbassare l'etÃ  biologica**\n\n`;
                    
                    response += `I tuoi fattori di impatto:\n\n`;
                    
                    if (impacts.rhr !== null && impacts.rhr !== undefined) {
                        const rhrColor = impacts.rhr <= 0 ? 'âœ…' : 'âš ï¸';
                        response += `${rhrColor} **RHR** (${avgs.resting_hr?.toFixed(0) || '--'} bpm): ${impacts.rhr > 0 ? '+' : ''}${impacts.rhr?.toFixed(1)} anni\n`;
                    }
                    if (impacts.vo2 !== null && impacts.vo2 !== undefined) {
                        const vo2Color = impacts.vo2 <= 0 ? 'âœ…' : 'âš ï¸';
                        response += `${vo2Color} **VO2 Max** (${avgs.vo2_max?.toFixed(0) || '--'}): ${impacts.vo2 > 0 ? '+' : ''}${impacts.vo2?.toFixed(1)} anni\n`;
                    }
                    if (impacts.sleep !== null && impacts.sleep !== undefined) {
                        const sleepColor = impacts.sleep <= 0 ? 'âœ…' : 'âš ï¸';
                        response += `${sleepColor} **Sonno** (${avgs.sleep_hours?.toFixed(1) || '--'}h): ${impacts.sleep > 0 ? '+' : ''}${impacts.sleep?.toFixed(1)} anni\n`;
                    }
                    if (impacts.steps !== null && impacts.steps !== undefined) {
                        const stepsColor = impacts.steps <= 0 ? 'âœ…' : 'âš ï¸';
                        response += `${stepsColor} **Passi** (${avgs.steps ? Math.round(avgs.steps).toLocaleString() : '--'}): ${impacts.steps > 0 ? '+' : ''}${impacts.steps?.toFixed(1)} anni\n`;
                    }
                    if (impacts.stress !== null && impacts.stress !== undefined) {
                        const stressColor = impacts.stress <= 0 ? 'âœ…' : 'âš ï¸';
                        response += `${stressColor} **Stress**: ${impacts.stress > 0 ? '+' : ''}${impacts.stress?.toFixed(1)} anni\n`;
                    }
                    if (impacts.hrz !== null && impacts.hrz !== undefined) {
                        const hrzColor = impacts.hrz <= 0 ? 'âœ…' : 'âš ï¸';
                        response += `${hrzColor} **High Intensity**: ${impacts.hrz > 0 ? '+' : ''}${impacts.hrz?.toFixed(1)} anni\n`;
                    }
                    
                    response += `\n**PrioritÃ  di intervento:**\n`;
                    
                    // Find worst factor
                    const factors = [
                        { name: 'Cardio (abbassa RHR)', value: impacts.rhr, fix: 'Zone 2 cardio 3x/settimana' },
                        { name: 'VO2 Max', value: impacts.vo2, fix: 'HIIT 2x/settimana' },
                        { name: 'Sonno', value: impacts.sleep, fix: '7-8 ore ogni notte' },
                        { name: 'Movimento', value: impacts.steps, fix: '10.000 passi/giorno' },
                        { name: 'Stress', value: impacts.stress, fix: 'Meditazione 10 min/giorno' },
                    ].filter(f => f.value > 0).sort((a, b) => b.value - a.value);
                    
                    if (factors.length > 0) {
                        factors.slice(0, 2).forEach((f, i) => {
                            response += `${i + 1}. **${f.name}**: ${f.fix}\n`;
                        });
                    } else {
                        response += `Stai andando alla grande! Mantieni le abitudini.\n`;
                    }
                    
                    return response;
                }
                
                // Analyze data
                if (q.includes('analiz') || q.includes('dati') || q.includes('data')) {
                    let response = `ðŸ“Š **Analisi Completa**\n\n`;
                    
                    response += `**EtÃ  biologica:** ${avgs.biological_age?.toFixed(1) || '--'} anni\n`;
                    response += `**EtÃ  reale:** ${data.real_age || '--'} anni\n`;
                    response += `**Differenza:** ${data.real_age && avgs.biological_age ? (data.real_age - avgs.biological_age).toFixed(1) : '--'} anni\n\n`;
                    
                    response += `**Medie 30 giorni:**\n`;
                    response += `â€¢ Recovery: ${avgs.recovery?.toFixed(0) || '--'}%\n`;
                    response += `â€¢ Strain: ${avgs.strain?.toFixed(1) || '--'}/21\n`;
                    response += `â€¢ Sonno: ${avgs.sleep_hours?.toFixed(1) || '--'}h\n`;
                    response += `â€¢ Sleep Performance: ${avgs.sleep_performance?.toFixed(0) || '--'}%\n`;
                    response += `â€¢ RHR: ${avgs.resting_hr?.toFixed(0) || '--'} bpm\n`;
                    response += `â€¢ Passi: ${avgs.steps ? Math.round(avgs.steps).toLocaleString() : '--'}\n`;
                    
                    return response;
                }
                
                // Motivation
                if (q.includes('motiv') || q.includes('forza') || q.includes('aiut')) {
                    const quotes = [
                        `ðŸ”¥ **"Il dolore Ã¨ temporaneo. La gloria Ã¨ per sempre."**\n\nOgni goccia di sudore Ã¨ un investimento nel tuo futuro. Ogni passo conta. Ogni scelta conta.\n\nNon stai solo costruendo un corpo - stai forgiando carattere.`,
                        `âš”ï¸ **"Non Ã¨ la montagna che conquistiamo, ma noi stessi."**\n\nI tuoi dati mostrano il cammino. Ma sei TU che devi camminare.\n\nOggi Ã¨ il giorno in cui il futuro te stesso ti ringrazierÃ .`,
                        `ðŸ§˜ **"L'acqua che scorre non diventa mai stagnante."**\n\nMuoviti. Riposa. Muoviti ancora. Ãˆ il ritmo della vita.\n\nNon cercare la perfezione - cerca il progresso.`,
                        `ðŸ’ª **"La disciplina Ã¨ il ponte tra obiettivi e risultati."**\n\nNon serve motivazione ogni giorno. Serve disciplina.\n\nFai oggi quello che gli altri non faranno, per avere domani quello che gli altri non avranno.`
                    ];
                    return quotes[Math.floor(Math.random() * quotes.length)];
                }
                
                // Default
                return `ðŸ¤” Non ho capito bene. Prova a chiedermi:\n\nâ€¢ "Come posso dormire meglio?"\nâ€¢ "Cosa devo fare oggi?"\nâ€¢ "Come abbasso l'etÃ  biologica?"\nâ€¢ "Analizza i miei dati"\nâ€¢ "Ho bisogno di motivazione"\n\nSono qui per guidarti nel tuo percorso.`;
            };
            
            const handleSend = () => {
                if (!input.trim()) return;
                
                const userMsg = input.trim();
                setMessages(prev => [...prev, { role: 'user', text: userMsg }]);
                setInput('');
                setLoading(true);
                
                // Simulate AI thinking
                setTimeout(() => {
                    const response = generateResponse(userMsg, userData);
                    setMessages(prev => [...prev, { role: 'ai', text: response }]);
                    setLoading(false);
                }, 500);
            };
            
            const formatMessage = (text) => {
                // Simple markdown-like formatting
                return text
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                    .replace(/\*(.*?)\*/g, '<em>$1</em>')
                    .replace(/\n/g, '<br/>');
            };
            
            return (
                <div className="flex flex-col h-[calc(100vh-120px)]">
                    {/* Chat messages */}
                    <div ref={chatRef} className="flex-1 overflow-y-auto p-4 space-y-4">
                        {messages.map((msg, i) => (
                            <div key={i} className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                                <div className={`max-w-[85%] p-4 ${msg.role === 'user' ? 'chat-bubble-user' : 'chat-bubble-ai'}`}>
                                    {msg.role === 'ai' && <div className="text-[#00ff88] text-xs mb-2 font-bold">ðŸ¥‹ SENSEI</div>}
                                    <div 
                                        className="text-sm leading-relaxed"
                                        dangerouslySetInnerHTML={{ __html: formatMessage(msg.text) }}
                                    />
                                </div>
                            </div>
                        ))}
                        {loading && (
                            <div className="flex justify-start">
                                <div className="chat-bubble-ai p-4">
                                    <div className="flex gap-1">
                                        <div className="w-2 h-2 bg-[#00ff88] rounded-full animate-bounce" style={{ animationDelay: '0ms' }}></div>
                                        <div className="w-2 h-2 bg-[#00ff88] rounded-full animate-bounce" style={{ animationDelay: '150ms' }}></div>
                                        <div className="w-2 h-2 bg-[#00ff88] rounded-full animate-bounce" style={{ animationDelay: '300ms' }}></div>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                    
                    {/* Input */}
                    <div className="p-4 border-t border-[#222]">
                        <div className="flex gap-2">
                            <input
                                type="text"
                                value={input}
                                onChange={e => setInput(e.target.value)}
                                onKeyPress={e => e.key === 'Enter' && handleSend()}
                                placeholder="Chiedi al Sensei..."
                                className="input-dark flex-1 px-4 py-3 rounded-xl"
                            />
                            <button onClick={handleSend} className="btn-primary px-6 py-3 rounded-xl">
                                â†’
                            </button>
                        </div>
                    </div>
                </div>
            );
        };
        
        // ==================== PAGES ====================
        
        const LandingPage = ({ onNavigate }) => (
            <div className="min-h-screen flex flex-col items-center justify-center p-6 text-center">
                <div className="bio-circle w-32 h-32 flex items-center justify-center mb-6">
                    <Particles />
                    <span className="text-4xl z-10">ðŸ§¬</span>
                </div>
                <h1 className="font-orbitron text-4xl font-bold text-white mb-2">SENSEI</h1>
                <p className="text-gray-500 mb-8">Biological Age + AI Coach</p>
                <div className="flex gap-4">
                    <button onClick={() => onNavigate('login')} className="btn-primary px-8 py-3 rounded-xl font-orbitron">LOGIN</button>
                    <button onClick={() => onNavigate('register')} className="btn-outline px-8 py-3 rounded-xl font-orbitron">REGISTER</button>
                </div>
            </div>
        );
        
        const LoginPage = ({ onNavigate, onLogin }) => {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');
            const [loading, setLoading] = useState(false);
            
            const handleSubmit = async (e) => {
                e.preventDefault();
                setLoading(true);
                try {
                    const res = await fetch(`${API}/api/login`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email, password })
                    });
                    const data = await res.json();
                    if (data.token) {
                        localStorage.setItem('token', data.token);
                        localStorage.setItem('user', JSON.stringify(data.user));
                        onLogin(data);
                    } else setError(data.error || 'Login failed');
                } catch (err) { setError('Connection error'); }
                finally { setLoading(false); }
            };
            
            return (
                <div className="min-h-screen flex items-center justify-center p-6">
                    <div className="w-full max-w-md">
                        <h1 className="font-orbitron text-2xl text-center mb-6">Login</h1>
                        <form onSubmit={handleSubmit} className="card p-6">
                            {error && <div className="bg-red-500/20 border border-red-500/50 rounded-lg p-3 mb-4 text-red-300 text-sm">{error}</div>}
                            <div className="mb-4">
                                <input type="email" value={email} onChange={e => setEmail(e.target.value)} className="input-dark w-full px-4 py-3 rounded-lg" placeholder="Email" required />
                            </div>
                            <div className="mb-4">
                                <input type="password" value={password} onChange={e => setPassword(e.target.value)} className="input-dark w-full px-4 py-3 rounded-lg" placeholder="Password" required />
                            </div>
                            <button type="submit" disabled={loading} className="btn-primary w-full py-3 rounded-lg font-orbitron disabled:opacity-50">
                                {loading ? '...' : 'LOGIN'}
                            </button>
                        </form>
                        <p className="text-center mt-4 text-gray-500 text-sm">
                            No account? <button onClick={() => onNavigate('register')} className="text-[#00ff88]">Register</button>
                        </p>
                    </div>
                </div>
            );
        };
        
        const RegisterPage = ({ onNavigate }) => {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [birthYear, setBirthYear] = useState('');
            const [error, setError] = useState('');
            const [success, setSuccess] = useState(false);
            const [loading, setLoading] = useState(false);
            
            const handleSubmit = async (e) => {
                e.preventDefault();
                setLoading(true);
                try {
                    const res = await fetch(`${API}/api/register`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email, password, birth_year: birthYear ? parseInt(birthYear) : null })
                    });
                    const data = await res.json();
                    if (data.user_id) setSuccess(true);
                    else setError(data.error || 'Failed');
                } catch (err) { setError('Connection error'); }
                finally { setLoading(false); }
            };
            
            if (success) {
                return (
                    <div className="min-h-screen flex items-center justify-center p-6">
                        <div className="card p-8 text-center">
                            <div className="text-4xl mb-4">âœ“</div>
                            <h2 className="font-orbitron text-xl text-[#00ff88] mb-4">Account Created!</h2>
                            <button onClick={() => onNavigate('login')} className="btn-primary px-6 py-2 rounded-lg">LOGIN</button>
                        </div>
                    </div>
                );
            }
            
            return (
                <div className="min-h-screen flex items-center justify-center p-6">
                    <div className="w-full max-w-md">
                        <h1 className="font-orbitron text-2xl text-center mb-6">Register</h1>
                        <form onSubmit={handleSubmit} className="card p-6">
                            {error && <div className="bg-red-500/20 border border-red-500/50 rounded-lg p-3 mb-4 text-red-300 text-sm">{error}</div>}
                            <div className="mb-4">
                                <input type="email" value={email} onChange={e => setEmail(e.target.value)} className="input-dark w-full px-4 py-3 rounded-lg" placeholder="Email" required />
                            </div>
                            <div className="mb-4">
                                <input type="password" value={password} onChange={e => setPassword(e.target.value)} className="input-dark w-full px-4 py-3 rounded-lg" placeholder="Password (min 6)" required minLength="6" />
                            </div>
                            <div className="mb-4">
                                <input type="number" value={birthYear} onChange={e => setBirthYear(e.target.value)} className="input-dark w-full px-4 py-3 rounded-lg" placeholder="Birth year (es. 1976)" min="1940" max="2010" />
                            </div>
                            <button type="submit" disabled={loading} className="btn-primary w-full py-3 rounded-lg font-orbitron disabled:opacity-50">
                                {loading ? '...' : 'CREATE ACCOUNT'}
                            </button>
                        </form>
                        <p className="text-center mt-4 text-gray-500 text-sm">
                            Have account? <button onClick={() => onNavigate('login')} className="text-[#00ff88]">Login</button>
                        </p>
                    </div>
                </div>
            );
        };
        
        const SetupPage = ({ token, onComplete }) => {
            const [garminEmail, setGarminEmail] = useState('');
            const [garminPassword, setGarminPassword] = useState('');
            const [error, setError] = useState('');
            const [step, setStep] = useState(1);
            const [loading, setLoading] = useState(false);
            
            const handleConnect = async (e) => {
                e.preventDefault();
                setLoading(true);
                setError('');
                try {
                    const res = await fetch(`${API}/api/garmin/connect`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                        body: JSON.stringify({ garmin_email: garminEmail, garmin_password: garminPassword })
                    });
                    const data = await res.json();
                    if (data.message?.includes('collegato')) {
                        setStep(2);
                        await fetch(`${API}/api/sync`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                            body: JSON.stringify({ days_back: 90 })
                        });
                        setStep(3);
                        setTimeout(() => onComplete(), 1500);
                    } else setError(data.error || 'Failed');
                } catch (err) { setError('Connection error'); }
                finally { setLoading(false); }
            };
            
            if (step >= 2) {
                return (
                    <div className="min-h-screen flex items-center justify-center">
                        <div className="text-center">
                            {step === 2 && <div className="w-12 h-12 border-4 border-[#111] border-t-[#00ff88] rounded-full animate-spin mx-auto mb-4"></div>}
                            {step === 3 && <div className="text-4xl mb-4">âœ“</div>}
                            <div className="font-orbitron text-[#00ff88]">{step === 2 ? 'Syncing 90 days...' : 'Ready!'}</div>
                        </div>
                    </div>
                );
            }
            
            return (
                <div className="min-h-screen flex items-center justify-center p-6">
                    <div className="w-full max-w-md">
                        <h1 className="font-orbitron text-2xl text-center mb-2">Connect Garmin</h1>
                        <p className="text-gray-500 text-center text-sm mb-6">To calculate your biological age</p>
                        <form onSubmit={handleConnect} className="card p-6">
                            {error && <div className="bg-red-500/20 border border-red-500/50 rounded-lg p-3 mb-4 text-red-300 text-sm">{error}</div>}
                            <div className="bg-[#0a0a0a] rounded-lg p-3 mb-4 text-xs text-gray-500">ðŸ”’ Encrypted credentials</div>
                            <div className="mb-4">
                                <input type="email" value={garminEmail} onChange={e => setGarminEmail(e.target.value)} className="input-dark w-full px-4 py-3 rounded-lg" placeholder="Garmin Email" required />
                            </div>
                            <div className="mb-4">
                                <input type="password" value={garminPassword} onChange={e => setGarminPassword(e.target.value)} className="input-dark w-full px-4 py-3 rounded-lg" placeholder="Garmin Password" required />
                            </div>
                            <button type="submit" disabled={loading} className="btn-primary w-full py-3 rounded-lg font-orbitron disabled:opacity-50">
                                {loading ? 'Connecting...' : 'CONNECT'}
                            </button>
                        </form>
                    </div>
                </div>
            );
        };
        
        const Dashboard = ({ token, user, onLogout }) => {
            const [summary, setSummary] = useState(null);
            const [trend, setTrend] = useState(null);
            const [loading, setLoading] = useState(true);
            const [syncing, setSyncing] = useState(false);
            const [tab, setTab] = useState('overview');
            
            useEffect(() => { fetchData(); }, []);
            
            const fetchData = async () => {
                const headers = { 'Authorization': `Bearer ${token}` };
                try {
                    const [sumRes, trendRes] = await Promise.all([
                        fetch(`${API}/api/metrics/summary?days=30`, { headers }),
                        fetch(`${API}/api/metrics/trend?days=90`, { headers })
                    ]);
                    setSummary(await sumRes.json());
                    setTrend(await trendRes.json());
                } catch (err) { console.error(err); }
                finally { setLoading(false); }
            };
            
            const handleSync = async () => {
                setSyncing(true);
                await fetch(`${API}/api/sync`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ days_back: 30 })
                });
                await fetchData();
                setSyncing(false);
            };
            
            if (loading) return <Loading />;
            
            const avgs = summary?.averages || {};
            const impacts = avgs.bio_impacts || {};
            const realAge = summary?.real_age || 42;
            const bioAge = avgs.biological_age;
            
            return (
                <div className="min-h-screen flex flex-col">
                    {/* Header */}
                    <header className="flex justify-between items-center p-3 border-b border-[#1a1a1a]">
                        <h1 className="font-orbitron text-lg font-bold">SENSEI</h1>
                        <div className="flex gap-2">
                            <button onClick={handleSync} disabled={syncing} className="btn-outline px-3 py-1 rounded-lg text-xs disabled:opacity-50">
                                {syncing ? 'âŸ³' : 'âŸ³ Sync'}
                            </button>
                            <button onClick={onLogout} className="text-gray-500 text-xs">Exit</button>
                        </div>
                    </header>
                    
                    {/* Tabs */}
                    <div className="flex border-b border-[#1a1a1a]">
                        {['overview', 'factors', 'trend', 'coach'].map(t => (
                            <button key={t} onClick={() => setTab(t)}
                                className={`flex-1 py-2 text-xs uppercase tracking-wider ${tab === t ? 'text-[#00ff88] border-b-2 border-[#00ff88]' : 'text-gray-500'}`}>
                                {t === 'coach' ? 'ðŸ¥‹ Coach' : t}
                            </button>
                        ))}
                    </div>
                    
                    <div className="flex-1 overflow-auto">
                        {tab === 'overview' && (
                            <div className="p-4 max-w-lg mx-auto animate-fadeIn">
                                <div className="flex justify-center py-6">
                                    <BioAgeCircle bioAge={bioAge} realAge={realAge} paceOfAging={trend?.pace_of_aging} />
                                </div>
                                
                                <div className="grid grid-cols-3 gap-2 mb-3">
                                    <MetricBox icon="â¤ï¸" label="RHR" value={avgs.resting_hr?.toFixed(0)} unit="bpm" color="#ff6b6b" />
                                    <MetricBox icon="ðŸ«" label="VO2" value={avgs.vo2_max?.toFixed(0)} color="#00ff88" />
                                    <MetricBox icon="ðŸ‘£" label="Steps" value={avgs.steps ? Math.round(avgs.steps/1000) + 'k' : null} color="#ffd93d" />
                                </div>
                                
                                <div className="grid grid-cols-3 gap-2 mb-3">
                                    <MetricBox icon="ðŸ˜´" label="Sleep" value={avgs.sleep_hours?.toFixed(1)} unit="h" color="#6c5ce7" />
                                    <MetricBox icon="âš¡" label="Recovery" value={avgs.recovery?.toFixed(0)} color="#00ff88" />
                                    <MetricBox icon="ðŸ”¥" label="Strain" value={avgs.strain?.toFixed(1)} color="#ff6b35" />
                                </div>
                                
                                <div className="card p-3 mb-3">
                                    <div className="flex justify-between items-center">
                                        <span className="text-gray-400 text-sm">ðŸ˜´ Sleep Performance</span>
                                        <span className="font-orbitron text-xl text-[#6c5ce7]">{avgs.sleep_performance?.toFixed(0) || '--'}%</span>
                                    </div>
                                </div>
                                
                                <div className="text-center text-xs text-gray-600">
                                    30-day avg â€¢ {summary?.period?.days_with_data || 0} days
                                </div>
                            </div>
                        )}
                        
                        {tab === 'factors' && (
                            <div className="p-4 max-w-lg mx-auto space-y-2 animate-fadeIn">
                                <h2 className="text-gray-400 text-xs uppercase tracking-widest mb-3">What's impacting your age</h2>
                                <ImpactBar icon="ðŸ«" label="VO2 Max" value={impacts.vo2} description={`${avgs.vo2_max?.toFixed(0) || '--'} ml/kg/min`} />
                                <ImpactBar icon="â¤ï¸" label="Resting HR" value={impacts.rhr} description={`${avgs.resting_hr?.toFixed(0) || '--'} bpm`} />
                                <ImpactBar icon="ðŸ˜´" label="Sleep" value={impacts.sleep} description={`${avgs.sleep_hours?.toFixed(1) || '--'} hours avg`} />
                                <ImpactBar icon="ðŸ‘£" label="Steps" value={impacts.steps} description={`${avgs.steps ? Math.round(avgs.steps).toLocaleString() : '--'} avg`} />
                                <ImpactBar icon="ðŸ˜¤" label="Stress" value={impacts.stress} />
                                <ImpactBar icon="ðŸ”¥" label="High Intensity" value={impacts.hrz} />
                                
                                <div className="card p-3 mt-4">
                                    <div className="flex justify-between items-center">
                                        <span className="text-gray-400 text-sm">Total Impact</span>
                                        <span className={`font-orbitron text-lg font-bold ${(realAge - bioAge) > 0 ? 'text-[#00ff88]' : 'text-[#ff6b35]'}`}>
                                            {bioAge ? (realAge - bioAge > 0 ? '' : '+') + (realAge - bioAge).toFixed(1) : '--'} years
                                        </span>
                                    </div>
                                </div>
                            </div>
                        )}
                        
                        {tab === 'trend' && (
                            <div className="p-4 max-w-lg mx-auto animate-fadeIn">
                                {trend?.data?.length > 0 ? (
                                    <>
                                        <TrendChart data={trend.data} realAge={realAge} />
                                        <div className="card p-4 mt-4">
                                            <div className="text-xs text-gray-500 uppercase">Pace of Aging</div>
                                            <div className={`font-orbitron text-2xl font-bold ${trend.pace_of_aging <= 0 ? 'text-[#00ff88]' : 'text-[#ff6b35]'}`}>
                                                {trend.pace_of_aging !== null ? (trend.pace_of_aging <= 0 ? '' : '+') + trend.pace_of_aging.toFixed(1) + 'x' : '--'}
                                            </div>
                                            <div className="text-xs text-gray-500 mt-1">
                                                {trend.pace_of_aging < -0.3 ? 'Getting younger!' : trend.pace_of_aging < 0.3 ? 'Stable' : 'Aging faster'}
                                            </div>
                                        </div>
                                    </>
                                ) : (
                                    <div className="text-center text-gray-500 py-10">Need 30+ days for trend</div>
                                )}
                            </div>
                        )}
                        
                        {tab === 'coach' && (
                            <AICoach userData={summary} />
                        )}
                    </div>
                </div>
            );
        };
        
        // ==================== MAIN ====================
        
        const App = () => {
            const [page, setPage] = useState('landing');
            const [token, setToken] = useState(localStorage.getItem('token'));
            const [user, setUser] = useState(JSON.parse(localStorage.getItem('user') || 'null'));
            
            useEffect(() => {
                if (token && user) setPage(user.garmin_connected ? 'dashboard' : 'setup');
            }, []);
            
            const handleLogin = (data) => {
                setToken(data.token);
                setUser(data.user);
                setPage(data.user.garmin_connected ? 'dashboard' : 'setup');
            };
            
            const handleLogout = () => {
                localStorage.clear();
                setToken(null);
                setUser(null);
                setPage('landing');
            };
            
            const handleSetupComplete = () => {
                const updated = { ...user, garmin_connected: true };
                setUser(updated);
                localStorage.setItem('user', JSON.stringify(updated));
                setPage('dashboard');
            };
            
            return (
                <>
                    {page === 'landing' && <LandingPage onNavigate={setPage} />}
                    {page === 'login' && <LoginPage onNavigate={setPage} onLogin={handleLogin} />}
                    {page === 'register' && <RegisterPage onNavigate={setPage} />}
                    {page === 'setup' && <SetupPage token={token} onComplete={handleSetupComplete} />}
                    {page === 'dashboard' && <Dashboard token={token} user={user} onLogout={handleLogout} />}
                </>
            );
        };
        
        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>