<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SENSEI & SAKURA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body, #root { height: 100%; overflow: hidden; }
        body { font-family: 'Inter', sans-serif; background: #000; color: #fff; }
        
        .card { background: #111; border: 1px solid #222; border-radius: 16px; }
        
        .input-dark {
            background: #111; border: 1px solid #333; color: #fff;
            font-size: 16px;
        }
        .input-dark:focus { border-color: #00ff88; outline: none; }
        .input-dark.sakura:focus { border-color: #ff88cc; }
        
        .btn-green {
            background: linear-gradient(135deg, #00ff88, #00cc6a);
            color: #000; font-weight: 600;
        }
        .btn-pink {
            background: linear-gradient(135deg, #ff88cc, #cc66aa);
            color: #000; font-weight: 600;
        }
        .btn-gray { background: #222; color: #888; }
        .btn-gray:hover { background: #333; color: #fff; }
        
        .chat-bubble {
            max-width: 85%;
            padding: 14px 18px;
            border-radius: 20px;
            font-size: 16px;
            line-height: 1.5;
        }
        .chat-ai-sensei {
            background: linear-gradient(135deg, #0a1f12, #111);
            border-left: 3px solid #00ff88;
            border-radius: 4px 20px 20px 20px;
        }
        .chat-ai-sakura {
            background: linear-gradient(135deg, #1f0a18, #111);
            border-left: 3px solid #ff88cc;
            border-radius: 4px 20px 20px 20px;
        }
        .chat-user {
            background: #1a1a1a;
            border-radius: 20px 20px 4px 20px;
        }
        
        .typing-dot {
            width: 8px; height: 8px; border-radius: 50%;
            animation: bounce 1.4s infinite;
        }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes bounce {
            0%, 60%, 100% { transform: translateY(0); opacity: 0.4; }
            30% { transform: translateY(-6px); opacity: 1; }
        }
        
        .tab-active { border-bottom: 2px solid currentColor; }
        
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 2px; }
        
        .fade-in { animation: fadeIn 0.25s ease; }
        @keyframes fadeIn { 
            from { opacity: 0; transform: translateY(8px); } 
            to { opacity: 1; transform: translateY(0); } 
        }
        
        .bio-ring {
            width: 160px; height: 160px;
            border-radius: 50%;
            background: conic-gradient(#00ff88 0%, #00ff88 var(--pct), #222 var(--pct));
            display: flex; align-items: center; justify-content: center;
        }
        .bio-ring-inner {
            width: 140px; height: 140px;
            border-radius: 50%;
            background: #000;
            display: flex; align-items: center; justify-content: center; flex-direction: column;
        }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        const API = '';
        
        // ==================== COMPONENTS ====================
        
        const Loading = () => (
            <div className="h-full flex items-center justify-center">
                <div className="w-10 h-10 border-4 border-[#222] border-t-[#00ff88] rounded-full animate-spin" />
            </div>
        );
        
        const BioAgeRing = ({ bioAge, realAge }) => {
            const diff = realAge && bioAge ? realAge - bioAge : 0;
            const pct = Math.max(0, Math.min(100, 50 + diff * 5));
            return (
                <div className="bio-ring" style={{ '--pct': `${pct}%` }}>
                    <div className="bio-ring-inner">
                        <div className="text-3xl font-bold">{bioAge?.toFixed(1) || '--'}</div>
                        <div className="text-xs text-gray-500 uppercase">Bio Age</div>
                        {diff !== 0 && (
                            <div className={`text-sm mt-1 ${diff > 0 ? 'text-[#00ff88]' : 'text-[#ff4444]'}`}>
                                {diff > 0 ? `-${diff.toFixed(1)}` : `+${Math.abs(diff).toFixed(1)}`} anni
                            </div>
                        )}
                    </div>
                </div>
            );
        };
        
        const MetricBox = ({ icon, label, value, unit, color }) => (
            <div className="card p-3 text-center">
                <div className="text-xl mb-1">{icon}</div>
                <div className="text-xl font-bold" style={{ color }}>{value ?? '--'}</div>
                <div className="text-[10px] text-gray-500 uppercase">{label}</div>
            </div>
        );
        
        const ImpactRow = ({ icon, label, value }) => {
            const good = value <= 0;
            return (
                <div className="flex items-center justify-between py-2 border-b border-[#1a1a1a]">
                    <span className="text-sm text-gray-400">{icon} {label}</span>
                    <span className={`font-medium ${good ? 'text-[#00ff88]' : 'text-[#ff6b35]'}`}>
                        {value != null ? (good ? '' : '+') + value.toFixed(1) : '--'} yr
                    </span>
                </div>
            );
        };
        
        // ==================== CHAT COMPONENT ====================
        
        const ChatView = ({ token, coach }) => {
            const [messages, setMessages] = useState([]);
            const [input, setInput] = useState('');
            const [loading, setLoading] = useState(false);
            const [ready, setReady] = useState(false);
            const chatRef = useRef(null);
            const inputRef = useRef(null);
            
            const isSakura = coach === 'sakura';
            const accent = isSakura ? '#ff88cc' : '#00ff88';
            const coachName = isSakura ? 'Sakura' : 'Sensei';
            const coachEmoji = isSakura ? 'üå∏' : 'ü•ã';
            const coachDesc = isSakura 
                ? 'Coach mentale e spirituale. Benessere, mindfulness, equilibrio emotivo.'
                : 'Preparatore atletico. Allenamento, performance, recupero, dati Garmin.';
            
            useEffect(() => {
                setMessages([]);
                setReady(false);
                loadHistory();
            }, [coach]);
            
            useEffect(() => {
                if (chatRef.current) {
                    chatRef.current.scrollTop = chatRef.current.scrollHeight;
                }
            }, [messages, loading]);
            
            const loadHistory = async () => {
                try {
                    const res = await fetch(`${API}/api/chat/history?coach=${coach}&limit=30`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (res.ok) {
                        const data = await res.json();
                        if (Array.isArray(data)) setMessages(data);
                    }
                } catch (e) {}
                setReady(true);
            };
            
            const send = async () => {
                const text = input.trim();
                if (!text || loading) return;
                
                setInput('');
                setMessages(prev => [...prev, { role: 'user', content: text }]);
                setLoading(true);
                
                try {
                    const res = await fetch(`${API}/api/chat`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                        body: JSON.stringify({ message: text, coach })
                    });
                    const data = await res.json();
                    setMessages(prev => [...prev, { 
                        role: 'assistant', 
                        content: data.response || data.error || 'Errore' 
                    }]);
                } catch {
                    setMessages(prev => [...prev, { role: 'assistant', content: 'Errore di connessione' }]);
                }
                setLoading(false);
                inputRef.current?.focus();
            };
            
            const suggestions = isSakura 
                ? ['Come mi sento?', 'Sono stressato', 'Aiutami a rilassarmi']
                : ['Come sto oggi?', 'Piano allenamento', 'Analizza i dati'];
            
            if (!ready) return <Loading />;
            
            return (
                <div className="flex flex-col h-full">
                    {/* Chat Messages */}
                    <div ref={chatRef} className="flex-1 overflow-y-auto p-4 space-y-4">
                        {messages.length === 0 ? (
                            <div className="h-full flex flex-col items-center justify-center text-center px-4">
                                <div className="text-5xl mb-4">{coachEmoji}</div>
                                <h2 className="text-2xl font-bold mb-2" style={{ color: accent }}>{coachName}</h2>
                                <p className="text-gray-400 text-sm mb-8 max-w-xs">{coachDesc}</p>
                                <div className="flex flex-wrap justify-center gap-2">
                                    {suggestions.map((s, i) => (
                                        <button key={i} onClick={() => setInput(s)}
                                            className="px-4 py-2 rounded-full text-sm border border-[#333] text-gray-400 hover:border-current hover:text-white transition-colors">
                                            {s}
                                        </button>
                                    ))}
                                </div>
                            </div>
                        ) : (
                            <>
                                {messages.map((m, i) => (
                                    <div key={i} className={`flex ${m.role === 'user' ? 'justify-end' : 'justify-start'} fade-in`}>
                                        <div className={`chat-bubble ${
                                            m.role === 'user' ? 'chat-user' : 
                                            isSakura ? 'chat-ai-sakura' : 'chat-ai-sensei'
                                        }`}>
                                            {m.role === 'assistant' && (
                                                <div className="flex items-center gap-2 mb-2">
                                                    <span className="text-lg">{coachEmoji}</span>
                                                    <span className="text-sm font-medium" style={{ color: accent }}>{coachName}</span>
                                                </div>
                                            )}
                                            <div className="whitespace-pre-wrap">{m.content}</div>
                                        </div>
                                    </div>
                                ))}
                                {loading && (
                                    <div className="flex justify-start fade-in">
                                        <div className={`chat-bubble ${isSakura ? 'chat-ai-sakura' : 'chat-ai-sensei'}`}>
                                            <div className="flex items-center gap-2 mb-2">
                                                <span className="text-lg">{coachEmoji}</span>
                                                <span className="text-sm font-medium" style={{ color: accent }}>{coachName}</span>
                                            </div>
                                            <div className="flex gap-1">
                                                <div className="typing-dot" style={{ background: accent }} />
                                                <div className="typing-dot" style={{ background: accent }} />
                                                <div className="typing-dot" style={{ background: accent }} />
                                            </div>
                                        </div>
                                    </div>
                                )}
                            </>
                        )}
                    </div>
                    
                    {/* Input */}
                    <div className="p-4 border-t border-[#1a1a1a] bg-black">
                        <div className="flex gap-3">
                            <input
                                ref={inputRef}
                                type="text"
                                value={input}
                                onChange={e => setInput(e.target.value)}
                                onKeyDown={e => e.key === 'Enter' && !e.shiftKey && send()}
                                placeholder={`Scrivi a ${coachName}...`}
                                className={`input-dark flex-1 px-4 py-3 rounded-2xl ${isSakura ? 'sakura' : ''}`}
                                disabled={loading}
                            />
                            <button 
                                onClick={send} 
                                disabled={loading || !input.trim()}
                                className={`${isSakura ? 'btn-pink' : 'btn-green'} px-6 rounded-2xl text-lg disabled:opacity-40`}>
                                ‚Üí
                            </button>
                        </div>
                    </div>
                </div>
            );
        };
        
        // ==================== DATA VIEW ====================
        
        const DataView = ({ summary }) => {
            const avgs = summary?.averages || {};
            const impacts = avgs.bio_impacts || {};
            const realAge = summary?.real_age || 42;
            
            return (
                <div className="h-full overflow-y-auto p-4">
                    <div className="max-w-md mx-auto">
                        {/* Bio Age */}
                        <div className="flex justify-center mb-6">
                            <BioAgeRing bioAge={avgs.biological_age} realAge={realAge} />
                        </div>
                        
                        {/* Metrics Grid */}
                        <div className="grid grid-cols-3 gap-2 mb-6">
                            <MetricBox icon="‚ù§Ô∏è" label="RHR" value={avgs.resting_hr?.toFixed(0)} color="#ff6b6b" />
                            <MetricBox icon="ü´Å" label="VO2" value={avgs.vo2_max?.toFixed(0)} color="#00ff88" />
                            <MetricBox icon="üë£" label="Steps" value={avgs.steps ? (avgs.steps/1000).toFixed(1)+'k' : null} color="#ffd93d" />
                            <MetricBox icon="üò¥" label="Sleep" value={avgs.sleep_hours?.toFixed(1)} color="#6c5ce7" />
                            <MetricBox icon="‚ö°" label="Recovery" value={avgs.recovery?.toFixed(0)} color="#00ff88" />
                            <MetricBox icon="üî•" label="Strain" value={avgs.strain?.toFixed(1)} color="#ff6b35" />
                        </div>
                        
                        {/* Impacts */}
                        <div className="card p-4">
                            <h3 className="text-xs text-gray-500 uppercase tracking-wider mb-2">Impatto sull'et√† biologica</h3>
                            <ImpactRow icon="ü´Å" label="VO2 Max" value={impacts.vo2} />
                            <ImpactRow icon="‚ù§Ô∏è" label="Frequenza cardiaca" value={impacts.rhr} />
                            <ImpactRow icon="üò¥" label="Sonno" value={impacts.sleep} />
                            <ImpactRow icon="üë£" label="Passi" value={impacts.steps} />
                            <ImpactRow icon="üò§" label="Stress" value={impacts.stress} />
                            <ImpactRow icon="üî•" label="Intensit√†" value={impacts.hrz} />
                        </div>
                        
                        <p className="text-center text-xs text-gray-600 mt-4">
                            Media ultimi 30 giorni
                        </p>
                    </div>
                </div>
            );
        };
        
        // ==================== TREND VIEW ====================
        
        const TrendView = ({ trend, realAge }) => {
            const canvasRef = useRef(null);
            const chartRef = useRef(null);
            
            useEffect(() => {
                if (!canvasRef.current || !trend?.data?.length) return;
                if (chartRef.current) chartRef.current.destroy();
                
                chartRef.current = new Chart(canvasRef.current.getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: trend.data.map(d => {
                            const date = new Date(d.date);
                            return date.toLocaleDateString('it', { day: '2-digit', month: 'short' });
                        }),
                        datasets: [
                            { 
                                label: 'Et√† Biologica', 
                                data: trend.data.map(d => d.biological_age), 
                                borderColor: '#00ff88', 
                                backgroundColor: 'rgba(0,255,136,0.1)', 
                                fill: true, 
                                tension: 0.4, 
                                pointRadius: 0 
                            },
                            { 
                                label: 'Et√† Reale', 
                                data: trend.data.map(() => realAge), 
                                borderColor: '#444', 
                                borderDash: [5, 5], 
                                pointRadius: 0 
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { 
                            legend: { 
                                labels: { color: '#666', font: { size: 11 } } 
                            } 
                        },
                        scales: {
                            x: { 
                                grid: { color: '#1a1a1a' }, 
                                ticks: { color: '#555', font: { size: 10 }, maxTicksLimit: 8 } 
                            },
                            y: { 
                                grid: { color: '#1a1a1a' }, 
                                ticks: { color: '#555' },
                                suggestedMin: realAge - 6,
                                suggestedMax: realAge + 3
                            }
                        }
                    }
                });
                
                return () => chartRef.current?.destroy();
            }, [trend, realAge]);
            
            if (!trend?.data?.length) {
                return (
                    <div className="h-full flex items-center justify-center">
                        <p className="text-gray-500">Servono pi√π dati per il trend</p>
                    </div>
                );
            }
            
            const pace = trend.pace_of_aging;
            
            return (
                <div className="h-full overflow-y-auto p-4">
                    <div className="max-w-md mx-auto">
                        <div className="card p-4 mb-4">
                            <div style={{ height: 220 }}>
                                <canvas ref={canvasRef} />
                            </div>
                        </div>
                        
                        <div className="card p-4">
                            <div className="text-xs text-gray-500 uppercase mb-1">Pace of Aging</div>
                            <div className={`text-3xl font-bold ${pace <= 0 ? 'text-[#00ff88]' : 'text-[#ff6b35]'}`}>
                                {pace != null ? (pace <= 0 ? '' : '+') + pace.toFixed(1) : '--'}
                                <span className="text-lg ml-1">anni/anno</span>
                            </div>
                            <div className="text-sm text-gray-500 mt-2">
                                {pace < -0.3 ? 'üéâ Stai ringiovanendo!' : 
                                 pace < 0.3 ? '‚ú® Invecchiamento rallentato' : 
                                 '‚ö†Ô∏è Invecchiamento accelerato'}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };
        
        // ==================== PROFILE VIEW ====================
        
        const ProfileView = ({ token, user, onUpdate, onLogout }) => {
            const [form, setForm] = useState({
                name: user?.name || '',
                birth_year: user?.birth_year || ''
            });
            const [saving, setSaving] = useState(false);
            const [saved, setSaved] = useState(false);
            
            const save = async () => {
                setSaving(true);
                try {
                    const res = await fetch(`${API}/api/profile`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                        body: JSON.stringify({
                            name: form.name,
                            birth_year: form.birth_year ? parseInt(form.birth_year) : null
                        })
                    });
                    if (res.ok) {
                        setSaved(true);
                        setTimeout(() => setSaved(false), 2000);
                        const updated = { ...user, name: form.name, birth_year: parseInt(form.birth_year) };
                        localStorage.setItem('user', JSON.stringify(updated));
                        onUpdate(updated);
                    }
                } catch {}
                setSaving(false);
            };
            
            const age = form.birth_year ? new Date().getFullYear() - parseInt(form.birth_year) : null;
            
            return (
                <div className="h-full overflow-y-auto p-4">
                    <div className="max-w-md mx-auto">
                        <h2 className="text-xl font-bold mb-6">Profilo</h2>
                        
                        <div className="card p-4 mb-4">
                            <div className="mb-4">
                                <label className="text-xs text-gray-500 block mb-1">Nome</label>
                                <input 
                                    type="text" 
                                    value={form.name} 
                                    onChange={e => setForm({...form, name: e.target.value})}
                                    className="input-dark w-full px-4 py-3 rounded-xl" 
                                    placeholder="Il tuo nome" 
                                />
                            </div>
                            
                            <div className="mb-4">
                                <label className="text-xs text-gray-500 block mb-1">Anno di nascita</label>
                                <input 
                                    type="number" 
                                    value={form.birth_year} 
                                    onChange={e => setForm({...form, birth_year: e.target.value})}
                                    className="input-dark w-full px-4 py-3 rounded-xl" 
                                    placeholder="1976" 
                                />
                                {age && <p className="text-xs text-gray-500 mt-1">Et√†: {age} anni</p>}
                            </div>
                            
                            <button onClick={save} disabled={saving} className="btn-green w-full py-3 rounded-xl">
                                {saving ? '...' : saved ? '‚úì Salvato' : 'Salva'}
                            </button>
                        </div>
                        
                        <div className="card p-4 mb-4">
                            <div className="text-sm text-gray-400 mb-2">
                                <span className="text-gray-600">Email:</span> {user?.email}
                            </div>
                            <div className="text-sm text-gray-400">
                                <span className="text-gray-600">Garmin:</span> {user?.garmin_connected ? '‚úÖ Connesso' : '‚ùå Non connesso'}
                            </div>
                        </div>
                        
                        <button onClick={onLogout} className="btn-gray w-full py-3 rounded-xl">
                            Logout
                        </button>
                    </div>
                </div>
            );
        };
        
        // ==================== AUTH PAGES ====================
        
        const LandingPage = ({ onNavigate }) => (
            <div className="h-full flex flex-col items-center justify-center p-6">
                <div className="flex gap-4 mb-6">
                    <div className="w-16 h-16 rounded-full bg-gradient-to-br from-[#00ff88] to-[#00aa55] flex items-center justify-center text-3xl">ü•ã</div>
                    <div className="w-16 h-16 rounded-full bg-gradient-to-br from-[#ff88cc] to-[#cc66aa] flex items-center justify-center text-3xl">üå∏</div>
                </div>
                <h1 className="text-3xl font-bold mb-2">SENSEI & SAKURA</h1>
                <p className="text-gray-500 mb-8">Corpo e Mente in Equilibrio</p>
                <div className="flex gap-3">
                    <button onClick={() => onNavigate('login')} className="btn-green px-8 py-3 rounded-xl">Login</button>
                    <button onClick={() => onNavigate('register')} className="btn-gray px-8 py-3 rounded-xl">Registrati</button>
                </div>
            </div>
        );
        
        const LoginPage = ({ onNavigate, onLogin }) => {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');
            const [loading, setLoading] = useState(false);
            
            const submit = async (e) => {
                e.preventDefault();
                setLoading(true);
                setError('');
                try {
                    const res = await fetch(`${API}/api/login`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email, password })
                    });
                    const data = await res.json();
                    if (data.token) {
                        localStorage.setItem('token', data.token);
                        localStorage.setItem('user', JSON.stringify(data.user));
                        onLogin(data);
                    } else {
                        setError(data.error || 'Login fallito');
                    }
                } catch {
                    setError('Errore di connessione');
                }
                setLoading(false);
            };
            
            return (
                <div className="h-full flex items-center justify-center p-6">
                    <form onSubmit={submit} className="w-full max-w-sm">
                        <h1 className="text-2xl font-bold text-center mb-6">Login</h1>
                        
                        {error && <div className="bg-red-500/10 border border-red-500/30 rounded-xl p-3 mb-4 text-red-400 text-sm">{error}</div>}
                        
                        <input 
                            type="email" 
                            value={email} 
                            onChange={e => setEmail(e.target.value)}
                            className="input-dark w-full px-4 py-3 rounded-xl mb-3" 
                            placeholder="Email" 
                            required 
                        />
                        <input 
                            type="password" 
                            value={password} 
                            onChange={e => setPassword(e.target.value)}
                            className="input-dark w-full px-4 py-3 rounded-xl mb-4" 
                            placeholder="Password" 
                            required 
                        />
                        <button type="submit" disabled={loading} className="btn-green w-full py-3 rounded-xl mb-4">
                            {loading ? '...' : 'Accedi'}
                        </button>
                        
                        <p className="text-center text-gray-500 text-sm">
                            Non hai un account? <button type="button" onClick={() => onNavigate('register')} className="text-[#00ff88]">Registrati</button>
                        </p>
                    </form>
                </div>
            );
        };
        
        const RegisterPage = ({ onNavigate }) => {
            const [form, setForm] = useState({ email: '', password: '', birth_year: '', name: '' });
            const [error, setError] = useState('');
            const [success, setSuccess] = useState(false);
            const [loading, setLoading] = useState(false);
            
            const submit = async (e) => {
                e.preventDefault();
                if (!form.birth_year) {
                    setError('Anno di nascita richiesto');
                    return;
                }
                setLoading(true);
                setError('');
                try {
                    const res = await fetch(`${API}/api/register`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ ...form, birth_year: parseInt(form.birth_year) })
                    });
                    const data = await res.json();
                    if (data.user_id) {
                        setSuccess(true);
                    } else {
                        setError(data.error || 'Errore');
                    }
                } catch {
                    setError('Errore di connessione');
                }
                setLoading(false);
            };
            
            if (success) {
                return (
                    <div className="h-full flex items-center justify-center p-6">
                        <div className="text-center">
                            <div className="text-5xl mb-4">‚úì</div>
                            <h2 className="text-xl font-bold text-[#00ff88] mb-4">Account creato!</h2>
                            <button onClick={() => onNavigate('login')} className="btn-green px-8 py-3 rounded-xl">Accedi</button>
                        </div>
                    </div>
                );
            }
            
            return (
                <div className="h-full flex items-center justify-center p-6">
                    <form onSubmit={submit} className="w-full max-w-sm">
                        <h1 className="text-2xl font-bold text-center mb-6">Registrazione</h1>
                        
                        {error && <div className="bg-red-500/10 border border-red-500/30 rounded-xl p-3 mb-4 text-red-400 text-sm">{error}</div>}
                        
                        <input 
                            value={form.name} 
                            onChange={e => setForm({...form, name: e.target.value})}
                            className="input-dark w-full px-4 py-3 rounded-xl mb-3" 
                            placeholder="Nome" 
                        />
                        <input 
                            type="email" 
                            value={form.email} 
                            onChange={e => setForm({...form, email: e.target.value})}
                            className="input-dark w-full px-4 py-3 rounded-xl mb-3" 
                            placeholder="Email" 
                            required 
                        />
                        <input 
                            type="password" 
                            value={form.password} 
                            onChange={e => setForm({...form, password: e.target.value})}
                            className="input-dark w-full px-4 py-3 rounded-xl mb-3" 
                            placeholder="Password" 
                            required 
                            minLength="6"
                        />
                        <input 
                            type="number" 
                            value={form.birth_year} 
                            onChange={e => setForm({...form, birth_year: e.target.value})}
                            className="input-dark w-full px-4 py-3 rounded-xl mb-4" 
                            placeholder="Anno di nascita *" 
                            required
                        />
                        <button type="submit" disabled={loading} className="btn-green w-full py-3 rounded-xl mb-4">
                            {loading ? '...' : 'Registrati'}
                        </button>
                        
                        <p className="text-center text-gray-500 text-sm">
                            Hai gi√† un account? <button type="button" onClick={() => onNavigate('login')} className="text-[#00ff88]">Accedi</button>
                        </p>
                    </form>
                </div>
            );
        };
        
        const SetupPage = ({ token, onComplete }) => {
            const [garmin, setGarmin] = useState({ email: '', password: '' });
            const [error, setError] = useState('');
            const [step, setStep] = useState(1);
            const [loading, setLoading] = useState(false);
            
            const connect = async (e) => {
                e.preventDefault();
                setLoading(true);
                setError('');
                try {
                    const res = await fetch(`${API}/api/garmin/connect`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                        body: JSON.stringify({ garmin_email: garmin.email, garmin_password: garmin.password })
                    });
                    const data = await res.json();
                    if (data.message?.includes('collegato')) {
                        setStep(2);
                        await fetch(`${API}/api/sync`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                            body: JSON.stringify({ days_back: 90 })
                        });
                        setStep(3);
                        setTimeout(onComplete, 1500);
                    } else {
                        setError(data.error || 'Errore');
                    }
                } catch {
                    setError('Errore di connessione');
                }
                setLoading(false);
            };
            
            if (step >= 2) {
                return (
                    <div className="h-full flex items-center justify-center">
                        <div className="text-center">
                            {step === 2 && <div className="w-10 h-10 border-4 border-[#222] border-t-[#00ff88] rounded-full animate-spin mx-auto mb-4" />}
                            {step === 3 && <div className="text-5xl mb-4">‚úì</div>}
                            <div className="text-[#00ff88]">{step === 2 ? 'Sincronizzazione in corso...' : 'Pronto!'}</div>
                        </div>
                    </div>
                );
            }
            
            return (
                <div className="h-full flex items-center justify-center p-6">
                    <form onSubmit={connect} className="w-full max-w-sm">
                        <h1 className="text-2xl font-bold text-center mb-2">Connetti Garmin</h1>
                        <p className="text-gray-500 text-center text-sm mb-6">Per personalizzare i tuoi coach</p>
                        
                        {error && <div className="bg-red-500/10 border border-red-500/30 rounded-xl p-3 mb-4 text-red-400 text-sm">{error}</div>}
                        
                        <div className="card p-3 mb-4 text-xs text-gray-500">üîí Le credenziali sono criptate</div>
                        
                        <input 
                            type="email" 
                            value={garmin.email} 
                            onChange={e => setGarmin({...garmin, email: e.target.value})}
                            className="input-dark w-full px-4 py-3 rounded-xl mb-3" 
                            placeholder="Email Garmin" 
                            required 
                        />
                        <input 
                            type="password" 
                            value={garmin.password} 
                            onChange={e => setGarmin({...garmin, password: e.target.value})}
                            className="input-dark w-full px-4 py-3 rounded-xl mb-4" 
                            placeholder="Password Garmin" 
                            required 
                        />
                        <button type="submit" disabled={loading} className="btn-green w-full py-3 rounded-xl">
                            {loading ? 'Connessione...' : 'Connetti'}
                        </button>
                    </form>
                </div>
            );
        };
        
        // ==================== MAIN DASHBOARD ====================
        
        const Dashboard = ({ token, user, onLogout, onUserUpdate }) => {
            const [tab, setTab] = useState('sensei');
            const [summary, setSummary] = useState(null);
            const [trend, setTrend] = useState(null);
            const [loading, setLoading] = useState(true);
            const [syncing, setSyncing] = useState(false);
            
            useEffect(() => {
                fetchData();
            }, []);
            
            const fetchData = async () => {
                try {
                    const headers = { 'Authorization': `Bearer ${token}` };
                    const [s, t] = await Promise.all([
                        fetch(`${API}/api/metrics/summary?days=30`, { headers }).then(r => r.ok ? r.json() : {}),
                        fetch(`${API}/api/metrics/trend?days=90`, { headers }).then(r => r.ok ? r.json() : {})
                    ]);
                    setSummary(s);
                    setTrend(t);
                } catch {}
                setLoading(false);
            };
            
            const sync = async () => {
                setSyncing(true);
                try {
                    await fetch(`${API}/api/sync`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                        body: JSON.stringify({ days_back: 14 })
                    });
                    await fetchData();
                } catch {}
                setSyncing(false);
            };
            
            if (loading) return <Loading />;
            
            const tabs = [
                { id: 'sensei', icon: 'ü•ã', color: '#00ff88' },
                { id: 'sakura', icon: 'üå∏', color: '#ff88cc' },
                { id: 'data', icon: 'üìä', color: '#fff' },
                { id: 'trend', icon: 'üìà', color: '#fff' },
                { id: 'profile', icon: '‚öôÔ∏è', color: '#fff' }
            ];
            
            return (
                <div className="h-full flex flex-col">
                    {/* Header */}
                    <header className="flex justify-between items-center px-4 py-3 border-b border-[#1a1a1a]">
                        <div className="font-bold">
                            {tab === 'sensei' && <span className="text-[#00ff88]">ü•ã Sensei</span>}
                            {tab === 'sakura' && <span className="text-[#ff88cc]">üå∏ Sakura</span>}
                            {tab === 'data' && <span>üìä Dati</span>}
                            {tab === 'trend' && <span>üìà Trend</span>}
                            {tab === 'profile' && <span>‚öôÔ∏è Profilo</span>}
                        </div>
                        <button onClick={sync} disabled={syncing} className="btn-gray px-3 py-1.5 rounded-lg text-xs">
                            {syncing ? '‚ü≥' : '‚ü≥ Sync'}
                        </button>
                    </header>
                    
                    {/* Content */}
                    <main className="flex-1 overflow-hidden">
                        {tab === 'sensei' && <ChatView token={token} coach="sensei" />}
                        {tab === 'sakura' && <ChatView token={token} coach="sakura" />}
                        {tab === 'data' && <DataView summary={summary} />}
                        {tab === 'trend' && <TrendView trend={trend} realAge={summary?.real_age || 42} />}
                        {tab === 'profile' && <ProfileView token={token} user={user} onUpdate={onUserUpdate} onLogout={onLogout} />}
                    </main>
                    
                    {/* Tab Bar */}
                    <nav className="flex border-t border-[#1a1a1a] bg-black">
                        {tabs.map(t => (
                            <button 
                                key={t.id} 
                                onClick={() => setTab(t.id)}
                                className={`flex-1 py-4 text-xl transition-all ${tab === t.id ? 'tab-active' : 'opacity-40'}`}
                                style={{ color: tab === t.id ? t.color : '#fff' }}
                            >
                                {t.icon}
                            </button>
                        ))}
                    </nav>
                </div>
            );
        };
        
        // ==================== APP ====================
        
        const App = () => {
            const [page, setPage] = useState('landing');
            const [token, setToken] = useState(localStorage.getItem('token'));
            const [user, setUser] = useState(JSON.parse(localStorage.getItem('user') || 'null'));
            
            useEffect(() => {
                if (token && user) {
                    setPage(user.garmin_connected ? 'dashboard' : 'setup');
                }
            }, []);
            
            const handleLogin = (data) => {
                setToken(data.token);
                setUser(data.user);
                setPage(data.user.garmin_connected ? 'dashboard' : 'setup');
            };
            
            const handleLogout = () => {
                localStorage.clear();
                setToken(null);
                setUser(null);
                setPage('landing');
            };
            
            const handleSetupComplete = () => {
                const updated = { ...user, garmin_connected: true };
                setUser(updated);
                localStorage.setItem('user', JSON.stringify(updated));
                setPage('dashboard');
            };
            
            return (
                <div className="h-full">
                    {page === 'landing' && <LandingPage onNavigate={setPage} />}
                    {page === 'login' && <LoginPage onNavigate={setPage} onLogin={handleLogin} />}
                    {page === 'register' && <RegisterPage onNavigate={setPage} />}
                    {page === 'setup' && <SetupPage token={token} onComplete={handleSetupComplete} />}
                    {page === 'dashboard' && <Dashboard token={token} user={user} onLogout={handleLogout} onUserUpdate={setUser} />}
                </div>
            );
        };
        
        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>